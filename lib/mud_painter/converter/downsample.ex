defmodule MudPainter.Converter.Downsample do
  @moduledoc """
  Downsamples rgb values to xterm 256 or 4 bit color code .
  """

  use Rustler, otp_app: :mud_painter, crate: "color"

  @c256to16_table {
    0,
    1,
    2,
    3,
    4,
    5,
    6,
    7,
    8,
    9,
    10,
    11,
    12,
    13,
    14,
    15,
    0,
    4,
    4,
    4,
    12,
    12,
    2,
    6,
    4,
    4,
    12,
    12,
    2,
    2,
    6,
    4,
    12,
    12,
    2,
    2,
    2,
    6,
    12,
    12,
    10,
    10,
    10,
    10,
    14,
    12,
    10,
    10,
    10,
    10,
    10,
    14,
    1,
    5,
    4,
    4,
    12,
    12,
    3,
    8,
    4,
    4,
    12,
    12,
    2,
    2,
    6,
    4,
    12,
    12,
    2,
    2,
    2,
    6,
    12,
    12,
    10,
    10,
    10,
    10,
    14,
    12,
    10,
    10,
    10,
    10,
    10,
    14,
    1,
    1,
    5,
    4,
    12,
    12,
    1,
    1,
    5,
    4,
    12,
    12,
    3,
    3,
    8,
    4,
    12,
    12,
    2,
    2,
    2,
    6,
    12,
    12,
    10,
    10,
    10,
    10,
    14,
    12,
    10,
    10,
    10,
    10,
    10,
    14,
    1,
    1,
    1,
    5,
    12,
    12,
    1,
    1,
    1,
    5,
    12,
    12,
    1,
    1,
    1,
    5,
    12,
    12,
    3,
    3,
    3,
    7,
    12,
    12,
    10,
    10,
    10,
    10,
    14,
    12,
    10,
    10,
    10,
    10,
    10,
    14,
    9,
    9,
    9,
    9,
    13,
    12,
    9,
    9,
    9,
    9,
    13,
    12,
    9,
    9,
    9,
    9,
    13,
    12,
    9,
    9,
    9,
    9,
    13,
    12,
    11,
    11,
    11,
    11,
    7,
    12,
    10,
    10,
    10,
    10,
    10,
    14,
    9,
    9,
    9,
    9,
    9,
    13,
    9,
    9,
    9,
    9,
    9,
    13,
    9,
    9,
    9,
    9,
    9,
    13,
    9,
    9,
    9,
    9,
    9,
    13,
    9,
    9,
    9,
    9,
    9,
    13,
    11,
    11,
    11,
    11,
    11,
    15,
    0,
    0,
    0,
    0,
    0,
    0,
    8,
    8,
    8,
    8,
    8,
    8,
    7,
    7,
    7,
    7,
    7,
    7,
    15,
    15,
    15,
    15,
    15,
    15
  }

  # Converts rgb or 256 color to a 16 color code (4bit).
  def color256_to_color16(code256) do
    elem(@c256to16_table, code256)
  end

  # nif - see native/color/src/lib.rs for source
  # for error handling in case the nif is not loaded
  def rgb_to_color256(_r, _g, _b), do: error()
  defp error(), do: :erlang.nif_error(:nif_not_loaded)
end
